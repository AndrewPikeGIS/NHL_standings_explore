---
title: "NHL standings investigation"
author: "Andrew Pike"
date: "11/17/2021"
output: html_document
---

## Load Libraries
```{r load_libraries, echo = FALSE, message= FALSE, warning= FALSE}

library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(reshape2)
library(kableExtra)
library(reactable)
print(.packages())

```

## Load Tables

All data was sourced from Hockey-Reference.com

Example -> https://www.hockey-reference.com/leagues/NHL_2021_standings.html

```{r load_tables, echo = FALSE, warning = FALSE, message = FALSE}
standings_2020_21 <- read_csv("data/2020_21_standings.csv")
standings_2019_20 <- read_csv("data/2019_20_standings.csv")
standings_2018_19 <- read_csv("data/2018_19_standings.csv")
standings_2017_18 <- read_csv("data/2017_18_standings.csv")
standings_2016_17 <- read_csv("data/2016_17_standings.csv")
standings_2015_16 <- read_csv("data/2015_16_standings.csv")
standings_2014_15 <- read_csv("data/2014_15_standings.csv")
standings_2013_14 <- read_csv("data/2013_14_standings.csv")
standings_2012_13 <- read_csv("data/2012_13_standings.csv")
standings_2011_12 <- read_csv("data/2011_12_standings.csv")
standings_2010_11 <- read_csv("data/2010_11_standings.csv")
standings_2009_10 <- read_csv("data/2009_10_standings.csv")
standings_2008_09 <- read_csv("data/2008_09_standings.csv")
standings_2007_08 <- read_csv("data/2007_08_standings.csv")
standings_2006_07 <- read_csv("data/2006_07_standings.csv")
standings_2005_06 <- read_csv("data/2005_06_standings.csv")

list_standings <- list(
    standings_2020_21,
    standings_2019_20,
    standings_2018_19,
    standings_2017_18,
    standings_2016_17,
    standings_2015_16,
    standings_2014_15,
    standings_2013_14,
    standings_2012_13,
    standings_2011_12,
    standings_2010_11,
    standings_2009_10,
    standings_2008_09,
    standings_2007_08,
    standings_2006_07,
    standings_2005_06
)

standings_merged <- bind_rows(list_standings, .id = "column_label")

```


## Clean Standings Table
```{r clean_data, echo = TRUE, warning = FALSE, message = FALSE}
clean_table <- function(df_in) {
    df_out <- df_in %>%
        separate(Overall, c("wins", "losses", "ot_losses"), "-") %>%
        separate(Shootout, c("so_wins", "so_losses"), "-") %>%
        separate(Overtime, c("ot_wins", "ot_only_losses"), "-") %>%
        mutate(
            ot_wins = as.numeric(ot_wins) + as.numeric(so_wins),
            wins = as.numeric(wins),
            losses = as.numeric(losses),
            ot_losses = as.numeric(ot_losses),
            year = case_when(
                column_label == 1 ~ "20_21",
                column_label == 2 ~ "19_20",
                column_label == 3 ~ "18_19",
                column_label == 4 ~ "17_18",
                column_label == 5 ~ "16_17",
                column_label == 6 ~ "15_16",
                column_label == 7 ~ "14_15",
                column_label == 8 ~ "13_14",
                column_label == 9 ~ "12_13",
                column_label == 10 ~ "11_12",
                column_label == 11 ~ "10_11",
                column_label == 12 ~ "09_10",
                column_label == 13 ~ "08_09",
                column_label == 14 ~ "07_08",
                column_label == 15 ~ "06_07",
                column_label == 16 ~ "05_06"
            )
        ) %>%
        select(
            Rk,
            Team,
            wins,
            losses,
            ot_losses,
            ot_wins,
            year
        )
    return(df_out)
}

clean_standings_merged <- clean_table(standings_merged)

kbl(clean_standings_merged) %>%
    kable_styling(
        bootstrap_options = c(
            "striped",
            "hover",
            "condensed",
            "responsive")) %>%
    scroll_box(width = "1000px", height = "500px")
```

## Clean division table
```{r clean_division_table, echo = TRUE, warning = FALSE, message = FALSE}
#quick division table clean up

div_conf <- read_csv("data/conference_division_alignment.csv")

div_conf_long <- div_conf %>%
    pivot_longer(
        !Team,
        names_to = "div_conf",
        values_to = "group"
    )

div_conf_split <- colsplit(
    div_conf_long$div_conf,
    "_",
    c("group_level", "year")
)

div_conf_long <- cbind(div_conf_long, div_conf_split)

```


## Apply points schemas

```{r, echo = TRUE, warning = FALSE, message = FALSE}
apply_point_system <- function(df_in) {
    df_out <- df_in %>%
        mutate(
            points_2 = (2 * wins) + (1 * ot_losses),
            points_3 = (3 * wins) + (2 * ot_wins) + (1 * ot_losses),
            points_win_loss = wins + ot_wins
        )
    return(df_out)
}

merged_standings_w_points <- apply_point_system(clean_standings_merged)

merged_standings_points_div <- merge(
    merged_standings_w_points,
    div_conf_long,
    by = c("Team", "year"),
    all = TRUE)

```

## Build Playoff Spot Functions

```{r, echo = FALSE, warning = FALSE, message = FALSE}

#2020 - 2021 playoff teams were top 4 in each division.

set_2020_2021_playoff_teams <- function(df_in) {

    df_out <- df_in %>%
        drop_na() %>%
        filter(
            year == "20_21",
            group_level == "div"
        ) %>%
        group_by(group) %>%
        mutate(
            div_order_p2 = order(
                order(
                    points_2,
                    decreasing = TRUE)),
            div_order_p3 = order(
                order(
                    points_3,
                    decreasing = TRUE)),
            div_order_win_loss = order(
                order(
                    points_win_loss,
                    decreasing = TRUE)),
            playoff_p2 = if_else(div_order_p2 <= 4, "yes", "no"),
            playoff_p3 = if_else(div_order_p3 <= 4, "yes", "no"),
            playoff_win_loss = if_else(div_order_win_loss <= 4, "yes", "no"),
        ) %>%
        ungroup()
    return(df_out)
}

filter_div <- function(df_in, division) {
    df_out <- df_in %>%
        filter(group == division)
    return(df_out)
}

playoff_table_select <- function(df_in, points_field, playoff_field) {
    df_out <- df_in %>%
        select(
            Team,
            group,
            wins,
            losses,
            ot_losses,
            ot_wins,
            !!points_field,
            !!playoff_field) %>%
        arrange(
            group,
            desc(!!points_field)) %>%
        rename(
            "Group" = group,
            "Wins" = wins,
            "Losses" = losses,
            "OT Losses" = ot_losses,
            "OT Wins" = ot_wins,
            "Points Earned" = !!points_field,
            "Playoff Birth Earned" = !!playoff_field
        )
    return(df_out)
}

get_div_team_count <- function(df_in, div_in) {
    df_out <- df_in %>%
        filter(Group == div_in)
    return(length(df_out$Team))
}

playoff_table_kable <- function(df_in) {
    central_count <- get_div_team_count(df_in, "Central")
    east_count <- get_div_team_count(df_in, "East")
    north_count <- get_div_team_count(df_in, "North")
    west_count <- get_div_team_count(df_in, "West")

    df_in %>%
        kable() %>%
        row_spec(1:4, bold = TRUE) %>%
        row_spec(
            (1 + central_count):(4 + central_count),
            bold = TRUE) %>%
        row_spec(
            (1 + central_count + east_count):(4 + central_count + east_count),
            bold = TRUE) %>%
        row_spec(
            (1 + central_count + east_count + north_count):(4 + central_count + east_count + north_count),      # nolint
            bold = TRUE) %>%
        kable_styling(
            bootstrap_options = c(
                "striped",
                "hover",
                "responsive")) %>%
        pack_rows(
            index = c(
                "Central" = central_count,
                "East" = east_count,
                "North" = north_count,
                "West" = west_count
                ))
}

find_playoff_changes <- function(df_in) {
    df_out <- df_in %>%
        filter(
            playoff_p2 != playoff_p3 | 
            playoff_p2 != playoff_win_loss |
            playoff_win_loss != playoff_p3
        )

    return(df_out)
}

#build function for playoff seeding 2014 - 2019
#top three in each division then two wildcards
set_2014_2019_div_seeding <- function(df_in) {
    div_winners_out <- df_in %>%
        filter(
            group_level == "div" &
            (year == "13_14" |
            year == "14_15" |
            year == "15_16" |
            year == "16_17" |
            year == "17_18" |
            year == "18_19")
        ) %>%
        drop_na() %>%
        group_by(
            group,
            year) %>%
        mutate(
            div_order_p2 = order(
                order(
                    points_2,
                    decreasing = TRUE)),
            div_order_p3 = order(
                order(
                    points_3,
                    decreasing = TRUE)),
            div_order_win_loss = order(
                order(
                    points_win_loss,
                    decreasing = TRUE)),
            playoff_p2 = if_else(div_order_p2 <= 3, "yes", "no"),
            playoff_p3 = if_else(div_order_p3 <= 3, "yes", "no"),
            playoff_win_loss = if_else(div_order_win_loss <= 3, "yes", "no"),
        ) %>%
        ungroup()
    return(div_winners_out)
}

set_2014_2019_conf_seeding <- function(df_in,
                                       filter_col,
                                       conf_order,
                                       playoff_col) {
    div_winners_out <- df_in %>%
        filter(
            group_level == "conf" &
            !!filter_col == "no" &
            (year == "13_14" |
            year == "14_15" |
            year == "15_16" |
            year == "16_17" |
            year == "17_18" |
            year == "18_19")
        ) %>%
        drop_na() %>%
        group_by(
            group,
            year
        ) %>%
        mutate(
            conf_order = order(
                order(
                    points_2,
                    decreasing = TRUE)),
            playoff_col = if_else(conf_order <= 3, "yes", "no"),
        ) %>%
        ungroup()
    return(div_winners_out)
}


test <- set_2014_2019_div_seeding(merged_standings_points_div)
View(test)

merged_standings_points_div <- merge(
    x = merged_standings_points_div,
    y = test[, c(
        "Team",
        "year",
        "playoff_p2",
        "playoff_p3",
        "playoff_win_loss")],
    by = c("Team", "year"),
    all.x = TRUE)
#build function for playoff seeding 2019 - 2020


test2 <- set_2014_2019_conf_seeding(
    merged_standings_points_div,
    quo(playoff_p2),
    "conf_order_p2",
    "playoff_p2"
)
    

View(test2)
```


## 2020-2021 Standings

### 2 Point System 
#### 1 point for overtime loss, 2 points for a regulation win

```{r, echo = FALSE, warning = FALSE, message = FALSE}

set_2020_2021_playoff_teams(
    merged_standings_points_div
    ) %>%
    playoff_table_select(quo(points_2), quo(playoff_p2)) %>%
    playoff_table_kable()

```

### 3 Point System
#### 1 point for overtime loss, 2 point for overtime win, 3 points for regulation win

```{r, echo = FALSE, warning = FALSE, message = FALSE}

set_2020_2021_playoff_teams(
    merged_standings_points_div
    ) %>%
    playoff_table_select(quo(points_3), quo(playoff_p3)) %>%
    playoff_table_kable()

```


### Win/Loss Point System
#### 1 point for regulation or overtime win, 0 points for regulation or overtime loss

```{r, echo = FALSE, warning = FALSE, message = FALSE}
set_2020_2021_playoff_teams(
    merged_standings_points_div
    ) %>%
    playoff_table_select(quo(points_win_loss), quo(playoff_win_loss)) %>%
    playoff_table_kable()
```

### Discrepancies between the points systems

```{r, echo = FALSE, warning = FALSE, message = FALSE}
discrepancies_df <- find_playoff_changes(
    set_2020_2021_playoff_teams(merged_standings_points_div)
)

```